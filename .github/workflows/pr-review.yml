name: ğŸ”„ Pre-Merge Checks

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  uv-sync:
    name: ğŸ”„ UV Sync
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: ğŸ”„ Sync dependencies
        run: uv sync
        working-directory: python

      - name: âœ… Verify lock file is up to date
        run: |
          uv sync --locked
          git diff --exit-code uv.lock
        working-directory: python

  python-build:
    name: ğŸ—ï¸ Python Build
    runs-on: ubuntu-latest
    needs: uv-sync

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: ğŸ”„ Sync dependencies
        run: uv sync
        working-directory: python

      - name: ğŸ—ï¸ Build package
        run: uv build
        working-directory: python

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: python/dist/
          retention-days: 1

  python-test:
    name: ğŸ§ª Python Test
    runs-on: ubuntu-latest
    needs: uv-sync

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: ğŸ”„ Sync dependencies
        run: uv sync
        working-directory: python

      - name: ğŸ§ª Run tests
        run: uv run python -m pytest --version || echo "No pytest configured, running basic import test"
        working-directory: python

      - name: ğŸ” Test imports and dependencies
        run: |
          uv run python -c "
          import sys
          sys.path.append('.')

          # Test main module
          try:
              import main
              print('âœ… Main module imports successfully')
          except ImportError as e:
              print(f'âŒ Failed to import main module: {e}')
              sys.exit(1)

          # Test methodsdk dependency
          try:
              from method_security import MethodClient
              print('âœ… MethodSecurity SDK imports successfully')
          except ImportError as e:
              print(f'âŒ Failed to import MethodSecurity SDK: {e}')
              sys.exit(1)

          # Test dotenv dependency
          try:
              from dotenv import load_dotenv
              print('âœ… python-dotenv imports successfully')
          except ImportError as e:
              print(f'âŒ Failed to import python-dotenv: {e}')
              sys.exit(1)

          print('âœ… All dependency imports successful!')
          "
        working-directory: python

      - name: ğŸ“‹ Validate project structure
        run: |
          echo "Validating Python project structure..."

          # Check required files exist
          test -f pyproject.toml || (echo "âŒ pyproject.toml not found" && exit 1)
          test -f main.py || (echo "âŒ main.py not found" && exit 1)
          test -f README.md || (echo "âŒ README.md not found" && exit 1)

          echo "âœ… All required files present"
        working-directory: python

  check:
    name: âœ… Check
    if: always()

    needs:
      - uv-sync
      - python-build
      - python-test

    runs-on: ubuntu-latest

    steps:
      - name: Require all jobs to succeed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
