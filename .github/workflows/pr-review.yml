name: 🔄 Pre-Merge Checks

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  uv-sync:
    name: 🔄 UV Sync
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: 📦 Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: 🔄 Sync dependencies
        run: uv sync
        working-directory: python

      - name: ✅ Verify lock file is up to date
        run: |
          uv sync --locked
          git diff --exit-code uv.lock
        working-directory: python

  python-build:
    name: 🏗️ Python Build
    runs-on: ubuntu-latest
    needs: uv-sync

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: 📦 Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: 🔄 Sync dependencies
        run: uv sync
        working-directory: python

      - name: 🏗️ Build package
        run: uv build
        working-directory: python

      - name: 📦 Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: python/dist/
          retention-days: 1

  python-test:
    name: 🧪 Python Test
    runs-on: ubuntu-latest
    needs: uv-sync

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: 📦 Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: 🔄 Sync dependencies
        run: uv sync
        working-directory: python

      - name: 🧪 Run tests
        run: uv run python -m pytest --version || echo "No pytest configured, running basic import test"
        working-directory: python

      - name: 🔍 Test imports and dependencies
        run: |
          uv run python -c "
          import sys
          sys.path.append('.')

          # Test main module
          try:
              import main
              print('✅ Main module imports successfully')
          except ImportError as e:
              print(f'❌ Failed to import main module: {e}')
              sys.exit(1)

          # Test methodsdk dependency
          try:
              from method_security import MethodClient
              print('✅ MethodSecurity SDK imports successfully')
          except ImportError as e:
              print(f'❌ Failed to import MethodSecurity SDK: {e}')
              sys.exit(1)

          # Test dotenv dependency
          try:
              from dotenv import load_dotenv
              print('✅ python-dotenv imports successfully')
          except ImportError as e:
              print(f'❌ Failed to import python-dotenv: {e}')
              sys.exit(1)

          print('✅ All dependency imports successful!')
          "
        working-directory: python

      - name: 📋 Validate project structure
        run: |
          echo "Validating Python project structure..."

          # Check required files exist
          test -f pyproject.toml || (echo "❌ pyproject.toml not found" && exit 1)
          test -f main.py || (echo "❌ main.py not found" && exit 1)
          test -f README.md || (echo "❌ README.md not found" && exit 1)

          echo "✅ All required files present"
        working-directory: python

  check:
    name: ✅ Check
    if: always()

    needs:
      - uv-sync
      - python-build
      - python-test

    runs-on: ubuntu-latest

    steps:
      - name: Require all jobs to succeed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
